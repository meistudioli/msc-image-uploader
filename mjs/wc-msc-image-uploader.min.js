import{_wcl}from"./common-lib.js";import{_wccss}from"./common-css.js";import Mustache from"./mustache.js";import"./wc-msc-circle-progress.js";const defaults={fieldname:"image",multiple:!1,limitation:{size:52428800,accept:".jpg,.jpeg,.png,.gif,.webp,.avif",minwidth:100,minheight:100,maxcount:10},placeholder:[],webservice:{url:"/",params:{},header:{},withCredentials:!1,timeout:3e4}},booleanAttrs=["multiple"],objectAttrs=["limitation","placeholder","webservice"],custumEvents={pick:"msc-image-uploader-pick",error:"msc-image-uploader-error",remove:"msc-image-uploader-remove",done:"msc-image-uploader-upload-done"},{down:evtDown,move:evtMove,up:evtUp}=_wcl.pursuer(),legalKey=["ArrowDown","ArrowUp","ArrowLeft","ArrowRight","Escape"],template=document.createElement("template"),templateUnit=(template.innerHTML=`
<style>
${_wccss}

:host{position:relative;display:block;}
.main {
  --gap: var(--msc-image-uploader-gap, 12px);
  --column-count: var(--msc-image-uploader-column-count, 4);
  --main-padding: .25em;
  --decoy-opacity: var(--msc-image-uploader-dragging-opacity, .5);
  --border-radius: var(--msc-image-uploader-unit-border-radius, 8px);

  /* main */
  --main-dnd-bgc: var(--msc-image-uploader-main-drop-overlay-color, rgba(0 0 0/.7));
  --main-dnd-hint-text-color: var(--msc-image-uploader-main-drop-hint-text-color, rgba(255 255 255));
  --main-dnd-hint-text-size: var(--msc-image-uploader-main-drop-hint-text-size, 40px);
  --main-dnd-hint-text: var(--msc-image-uploader-main-drop-hint-text, 'DROP IMAGES HERE.');
  --main-dnd-display: var(--msc-image-uploader-main-drop-display, none);
  --main-focus-within-bgc: var(--msc-image-uploader-focus-within-bgc, rgba(255 255 255/.01));
  
  /* progress */
  --progress-size: clamp(1em, 14%, 1.8em);
  --bgc-progress: rgba(0 0 0/.15);
  --msc-circle-progress-font-size: 0px;
  --msc-circle-progress-color: rgba(255 255 255);
  --msc-circle-progress-placeholder-color: rgba(0 0 0/.5);
  --progress-scale-normal: .001;
  --progress-scale-active: 1;
  --progress-scale: var(--progress-scale-normal);

  /* button */
  --button-size: clamp(2em, 28%, 2.7em);
  --button-mask: path('M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z');
  --button-scale-normal: .001;
  --button-scale-active: 1;
  --button-scale: var(--button-scale-normal);
  --button-pointer-events: none;

  /* label */
  --label-bgc: var(--msc-image-uploader-label-bgc, rgba(232 234 237/.04));
  --label-color: var(--msc-image-uploader-label-color, #606367);
  --label-mask: path('M9 42q-1.25 0-2.125-.875T6 39V9q0-1.25.875-2.125T9 6h20.45v3H9v30h30V18.6h3V39q0 1.25-.875 2.125T39 42Zm26-24.9v-4.05h-4.05v-3H35V6h3v4.05h4.05v3H38v4.05ZM12 33.9h24l-7.2-9.6-6.35 8.35-4.7-6.2ZM9 9v30V9Z');
  --label-hint-text: var(--msc-image-uploader-label-hint-text, 'pick images');

  /* warn */
  --warn-bar-size: .75em;
  --warn-bar-strip-start-color: #de2f21;
  --warn-bar-strip-end-color: rgba(0 0 0);
  --warn-scale-normal: .001;
  --warn-scale-active: 1;
  --warn-scale: var(--warn-scale-normal);

  /* loading */
  --loading-color: var(--msc-image-uploader-loading-color, rgba(255 255 255));
  --loading-bgc: var(--msc-image-uploader-loading-bgc, rgba(0 0 0/.05));
  --loading-opacity-normal: 0;
  --loading-opacity-active: 1;
  --loading-opacity: var(--loading-opacity-normal);
}

.msc-image-uploader__unit {
  --unit-border-radius: var(--border-radius);
  --unit-indicator-pointer-events: none;

  --unit-border-color: var(--msc-image-uploader-unit-focus-border-color, #69a2f9);
  --unit-border-opacity-normal: 0;
  --unit-border-opacity-active: 1;
  --unit-border-opacity: var(--unit-border-opacity-normal);

  --unit-overlay-color: var(--msc-image-uploader-unit-overlay-color, rgba(255 255 255/.15));
  --unit-overlay-opacity-normal: 0;
  --unit-overlay-opacity-active: 1;
  --unit-overlay-opacity: var(--unit-overlay-opacity-normal);

  --unit-vision-visibility: visible;
}

.msc-image-uploader__unit__button {
  --button-bgc-opacity-normal: .2;
  --button-bgc-opacity-active: .65;
  --button-bgc-opacity: var(--button-bgc-opacity-normal);
  --button-bgc: rgba(0 0 0/var(--button-bgc-opacity));
}

.msc-image-uploader__unit__decoy {
  --x: 0px;
  --y: 0px;
  --inline-size: 0px;
  --block-size: 0px;
}

.main{position:relative;outline:0 none;}
.main::before{position:absolute;inset-inline-start:0;inset-block-start:0;inline-size:100%;block-size:100%;content:'';background-color:var(--main-dnd-bgc);z-index:4;border-radius:var(--border-radius);overflow:hidden;display:var(--main-dnd-display);}
.main::after{position:absolute;inset-inline:0;inset-block:0;margin:auto;inline-size:fit-content;block-size:fit-content;font-size:var(--main-dnd-hint-text-size);color:var(--main-dnd-hint-text-color);content:var(--main-dnd-hint-text);z-index:5;display:var(--main-dnd-display);}
.main:focus-within{background-color:var(--main-focus-within-bgc);}

.grids{padding:var(--gap);display:grid;grid-template-columns:repeat(var(--column-count),1fr);gap:var(--gap);}
.msc-image-uploader__unit{position:relative;inline-size:100%;aspect-ratio:1/1;border-radius:var(--unit-border-radius);overflow:hidden;outline:0 none;}
.msc-image-uploader__unit__img{position:relative;inline-size:100%;block-size:100%;object-fit:cover;display:block;visibility:var(--unit-vision-visibility);}

/* overlay > ::before:overlay / ::after:border */
.msc-image-uploader__unit::before{position:absolute;inset-inline-start:0;inset-block-start:0;inline-size:100%;block-size:100%;content:'';box-sizing:border-box;border-radius:var(--unit-border-radius);background-color:var(--unit-overlay-color);transition:opacity 150ms ease;opacity:var(--unit-overlay-opacity);will-change:opacity;pointer-events:var(--unit-indicator-pointer-events);z-index:1;}
.msc-image-uploader__unit::after{position:absolute;inset-inline-start:0;inset-block-start:0;inline-size:100%;block-size:100%;content:'';box-sizing:border-box;border:var(--main-padding) dashed var(--unit-border-color);border-radius:var(--unit-border-radius);transition:opacity 150ms ease;opacity:var(--unit-border-opacity);will-change:opacity;pointer-events:var(--unit-indicator-pointer-events);z-index:1;}

/* progress */
.msc-image-uploader__circle-progress{position:absolute;inset-inline-end:var(--main-padding);inset-block-end:var(--main-padding);inline-size:var(--progress-size);block-size:var(--progress-size);border-radius:var(--progress-size);background-color:var(--bgc-progress);box-shadow:0 0 0 2px var(--bgc-progress);pointer-events:none;transition:transform 200ms ease-in-out;transform:scale(var(--progress-scale));}

/* button */
.msc-image-uploader__unit__button{position:absolute;inset-inline-end:var(--main-padding);inset-block-start:var(--main-padding);inline-size:var(--button-size);aspect-ratio:1/1;border-radius:var(--button-size);color:transparent;appearance:none;border:0 none;overflow:hidden;display:block;outline:0 none;background-color:var(--button-bgc);will-change:background-color,transform;transition:background-color 200ms ease,transform 200ms ease-in-out;transform:scale(var(--button-scale));pointer-events:var(--button-pointer-events);z-index:2;}
.msc-image-uploader__unit__button::before{position:absolute;inset-inline:0;inset-block:0;margin:auto;inline-size:1.5em;block-size:1.5em;content:'';background-color:rgba(255 255 255);clip-path:var(--button-mask);}
.msc-image-uploader__unit__button:focus-visible{--button-bgc-opacity:var(--button-bgc-opacity-active);}
.msc-image-uploader__unit__button:active{transform:scale(.9);transition:unset;}

/* label */
.msc-image-uploader__unit--label{position:relative;display:flex;align-items:center;flex-direction:column;justify-content:center;gap:.25em;background-color:var(--label-bgc);overflow:hidden;}
.msc-image-uploader__unit--label::after{opacity:0;}
.msc-image-uploader__unit--label:active{transform:scale(.95);}
.msc-image-uploader__unit__icon{inline-size:3em;block-size:3em;background-color:var(--label-color);clip-path:var(--label-mask);display:block;opacity:1;}
.msc-image-uploader__unit__span{font-size:.875em;color:var(--label-color);white-space:nowrap;}
.msc-image-uploader__unit__span::before{content:var(--label-hint-text);}
.msc-image-uploader__unit__span:blank{display:none;}
.msc-image-uploader__unit--label:focus-visible{--unit-overlay-opacity:var(--unit-overlay-opacity-active);}
.msc-image-uploader__unit__input{position:absolute;inset-block-start:0;visibility:hidden;opacity:0;}

/* decoy */
.msc-image-uploader__unit__decoy{position:fixed;inset-inline-start:var(--x);inset-block-start:var(--y);inline-size:var(--inline-size);block-size:var(--block-size);opacity:var(--decoy-opacity);display:none;}
.msc-image-uploader__unit__decoy--show{display:block;z-index:2147483647;pointer-events:none;transform:scale(1.03);}
.msc-image-uploader__unit__decoy--mutate-size{}
.msc-image-uploader__unit__decoy--mutate-axis{}

/* warn */
.msc-image-uploader__unit__warn{position:absolute;inset-inline-start:0;inset-block-start:0;inline-size:100%;block-size:100%;background-color:rgba(255 0 0/.3);pointer-events:none;animation:animate-warn 1s ease-in-out infinite;transition:transform 150ms ease-in-out;will-change:opacity,transform;transform:scale(var(--warn-scale));border-radius:var(--unit-border-radius);overflow:hidden;}
.msc-image-uploader__unit__warn::before,
.msc-image-uploader__unit__warn::after{position:absolute;inset-inline-start:0;inline-size:100%;block-size:var(--warn-bar-size);content:'';background-size:24px var(--warn-bar-size);background-image:-webkit-linear-gradient(-45deg, var(--warn-bar-strip-start-color) 33%, var(--warn-bar-strip-end-color) 33%, var(--warn-bar-strip-end-color) 66%, var(--warn-bar-strip-start-color) 66%);}
.msc-image-uploader__unit__warn::before{inset-block-start:0;animation:animate-warn-bar-block-start 60s linear infinite;}
.msc-image-uploader__unit__warn::after{inset-block-end:0;animation:animate-warn-bar-block-end 60s linear infinite;}
.msc-image-uploader__unit__warn__span{position:absolute;inset-block:0;margin:auto;inline-size:100%;block-size:fit-content;display:block;background-color:rgba(0 0 0/.75);color:var(--warn-bar-strip-start-color);line-height:2.2;text-align:center;font-size:1em;font-weight:800;border-block-start:2px solid var(--warn-bar-strip-start-color);border-block-end:2px solid var(--warn-bar-strip-start-color);}

@keyframes animate-warn-bar-block-start {
  100% { background-position: -3000% 0px; }
}

@keyframes animate-warn-bar-block-end {
  100% { background-position: 3000% 0px; }
}

@keyframes animate-warn {
  0% { opacity: .5; }
  50% { opacity: 1; }
  100%{ opacity: .5; }
}

/* loading: https://loading.io/css/ */
.msc-image-uploader__loading{position:absolute;inset-inline-end:var(--gap);inset-block-end:var(--gap);inline-size:80px;block-size:80px;border-radius:80px;background-color:var(--loading-bgc);transform:scale(.5);transform-origin:100% 100%;pointer-events:none;z-index:3;transition:opacity 200ms ease;will-change:opacity;opacity:var(--loading-opacity);}
.lds-ripple{display:inline-block;position:relative;inline-size:80px;block-size:80px;}
.lds-ripple div{position:absolute;border:4px solid var(--loading-color);opacity:1;border-radius:50%;animation:lds-ripple 1s cubic-bezier(0, 0.2, 0.8, 1) infinite;}
.lds-ripple div:nth-child(2){animation-delay:-0.5s;}

/* decoration */
.msc-image-uploader__unit__decoration{position:absolute;inset-inline-start:0;inset-block-start:0;inline-size:100%;block-size:100%;pointer-events:none;border-radius:var(--unit-border-radius);overflow:hidden;z-index:1;contain:content;}

@keyframes lds-ripple {
  0% { top:36px;left:36px;width:0;height:0;opacity:0; }
  4.9% { top:36px;left:36px;width:0;height:0;opacity:0; }
  5% { top:36px;left:36px;width:0;height:0;opacity:1; }
  100% { top:0px;left:0px;width:72px;height:72px;opacity:0; }
}

/* status */
[data-status=normal],
[data-status=warn] {
  --button-scale: var(--button-scale-active);
  --button-pointer-events: auto;
  cursor: move;
}

[data-status=process] {
  --progress-scale: var(--progress-scale-active);
}

[data-status=drag] {
  --unit-overlay-opacity: var(--unit-overlay-opacity-active);
  --unit-border-opacity: var(--unit-border-opacity-active);
  --unit-vision-visibility: hidden;
  --unit-indicator-pointer-events: auto;
}

[data-status=warn] {
  --warn-scale: var(--warn-scale-active);
}

.msc-image-uploader__unit:not(label):focus {
  --unit-overlay-opacity: var(--unit-overlay-opacity-active);
  --unit-border-opacity: var(--unit-border-opacity-active);

  --button-scale: var(--button-scale-normal);
  --button-pointer-events: none;
}

.msc-image-uploader__unit--dismiss{animation:dismiss 300ms ease forwards;}

.main--loading{--loading-opacity:var(--loading-opacity-active);}
.main[data-action=dragging] .msc-image-uploader__unit__button{pointer-events:none;}
.main--mutate{}

/* msc-image-uploader--blank-trigger */
:host(.msc-image-uploader--blank-trigger) .main[data-action] .msc-image-uploader__unit--label{visibility:hidden;}
:host(.msc-image-uploader--blank-trigger) .msc-image-uploader__unit--label:not(:only-child) {
  position: absolute;
  inset-inline-start: var(--gap);
  inset-block-start: var(--gap);
  inline-size: calc((100% - (var(--gap) * 2) - ((var(--column-count) - 1) * var(--gap))) /  var(--column-count));
}

@media (hover: hover) {
  .msc-image-uploader__unit:not(.msc-image-uploader__unit__decoy):hover::before{--unit-overlay-opacity:var(--unit-overlay-opacity-active);}
  .msc-image-uploader__unit__button:hover{--button-bgc-opacity:var(--button-bgc-opacity-active);}
}

@keyframes dismiss {
  0% {
    transform: translateY(0);
    opacity: 1;
  }
  100% {
    transform: translateY(-20%);
    opacity: 0;
  }
}
</style>

<div class="main main--mutate" ontouchstart="" tabindex="0">
  <div class="grids">
    <label class="msc-image-uploader__unit msc-image-uploader__unit--label" aria-label="pick images" tabindex="0">
      <em class="msc-image-uploader__unit__icon stuff"></em>
      <span class="msc-image-uploader__unit__span"></span>
      <input class="msc-image-uploader__unit__input" type="file" accept="${defaults.limitation.accept}" tabindex="-1" />
    </label>
  </div>

  <div class="msc-image-uploader__loading">
    <div class="lds-ripple">
      <div></div>
      <div></div>
    </div>
  </div>

  <div class="msc-image-uploader__unit msc-image-uploader__unit__decoy msc-image-uploader__unit__decoy--mutate-size msc-image-uploader__unit__decoy--mutate-axis">
    <img class="msc-image-uploader__unit__img" src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" width="1" height="1" />
  </div>
</div>
`,document.createElement("template"));if(templateUnit.innerHTML=`
{{#units}}
<div id="{{id}}" class="msc-image-uploader__unit" data-status="{{status}}" tabindex="0">
  <em class="msc-image-uploader__unit__decoration" part></em>
  <img class="msc-image-uploader__unit__img" src="{{src}}" width="1" height="1" alt="msc-image-uploader unit" />
  <div class="msc-image-uploader__circle-progress">
    <msc-circle-progress size="3" value="0" round></msc-circle-progress>
  </div>
  <div class="msc-image-uploader__unit__warn">
    <span class="msc-image-uploader__unit__warn__span">ERROR</span>
  </div>
  <button type="button" class="msc-image-uploader__unit__button" tabindex="0">remove</button>
</div>
{{/units}}
`,CSS?.registerProperty)try{CSS.registerProperty({name:"--msc-image-uploader-gap",syntax:"<length>",inherits:!0,initialValue:"12px"}),CSS.registerProperty({name:"--msc-image-uploader-column-count",syntax:"<number>",inherits:!0,initialValue:"4"}),CSS.registerProperty({name:"--msc-image-uploader-dragging-opacity",syntax:"<number>",inherits:!0,initialValue:".5"}),CSS.registerProperty({name:"--msc-image-uploader-unit-border-radius",syntax:"<length>",inherits:!0,initialValue:"8px"}),CSS.registerProperty({name:"--msc-image-uploader-main-drop-overlay-color",syntax:"<color>",inherits:!0,initialValue:"rgba(0 0 0/.7)"}),CSS.registerProperty({name:"--msc-image-uploader-main-drop-hint-text-color",syntax:"<color>",inherits:!0,initialValue:"rgba(255 255 255)"}),CSS.registerProperty({name:"--msc-image-uploader-main-drop-hint-text-size",syntax:"<length>",inherits:!0,initialValue:"40px"}),CSS.registerProperty({name:"--msc-image-uploader-focus-within-bgc",syntax:"<color>",inherits:!0,initialValue:"rgba(255 255 255/.01)"}),CSS.registerProperty({name:"--msc-image-uploader-label-bgc",syntax:"<color>",inherits:!0,initialValue:"rgba(232 234 237/.04)"}),CSS.registerProperty({name:"--msc-image-uploader-label-color",syntax:"<color>",inherits:!0,initialValue:"#606367"}),CSS.registerProperty({name:"--msc-image-uploader-unit-overlay-color",syntax:"<color>",inherits:!0,initialValue:"rgba(255 255 255/.15)"}),CSS.registerProperty({name:"--msc-image-uploader-unit-focus-border-color",syntax:"<color>",inherits:!0,initialValue:"#69a2f9"}),CSS.registerProperty({name:"--msc-image-uploader-loading-color",syntax:"<color>",inherits:!0,initialValue:"rgba(255 255 255)"}),CSS.registerProperty({name:"--msc-image-uploader-loading-bgc",syntax:"<color>",inherits:!0,initialValue:"rgba(0 0 0/.05)"})}catch(e){console.warn("msc-image-uploader: "+e.message)}class MscImageUploader extends HTMLElement{#data;#nodes;#config;constructor(e){super(),this.attachShadow({mode:"open",delegatesFocus:!1}),this.shadowRoot.appendChild(template.content.cloneNode(!0)),this.#data={controller:"",ddController:"",dX:0,dY:0,units:{}},this.#nodes={styleSheet:this.shadowRoot.querySelector("style"),main:this.shadowRoot.querySelector(".main"),grids:this.shadowRoot.querySelector(".grids"),decoy:this.shadowRoot.querySelector(".msc-image-uploader__unit__decoy"),input:this.shadowRoot.querySelector(".msc-image-uploader__unit__input"),activeTarget:""},this.#config={...defaults,...e},this._onDown=this._onDown.bind(this),this._onMove=this._onMove.bind(this),this._onUp=this._onUp.bind(this),this._onAnimationEnd=this._onAnimationEnd.bind(this),this._onKeyDown=this._onKeyDown.bind(this),this._onFilesChange=this._onFilesChange.bind(this),this._onPaste=this._onPaste.bind(this),this._onDnD=this._onDnD.bind(this),this._onClick=this._onClick.bind(this)}async connectedCallback(){var{config:e,error:t}=await _wcl.getWCConfig(this),{main:a,grids:i,input:r}=this.#nodes;t?(console.warn(_wcl.classToTagName(this.constructor.name)+": "+t),this.remove()):(this.#config={...this.#config,...e},Object.keys(defaults).forEach(e=>this.#upgradeProperty(e)),this.#data.controller=new AbortController,t=this.#data.controller.signal,i.addEventListener(evtDown,this._onDown,{signal:t}),i.addEventListener("animationend",this._onAnimationEnd,{signal:t}),i.addEventListener("click",this._onClick,{signal:t}),r.addEventListener("change",this._onFilesChange,{signal:t}),a.addEventListener("keydown",this._onKeyDown,{signal:t,capture:!0}),a.addEventListener("paste",this._onPaste,{signal:t}),a.addEventListener("dragover",this._onDnD,{signal:t}),a.addEventListener("drop",this._onDnD,{signal:t}))}disconnectedCallback(){this.#data?.controller&&this.#data.controller.abort()}#format(a,e,i){if(null!==i)switch(a){case"fieldname":this.#config[a]=0<i.length?i:defaults.fieldname;break;case"multiple":this.#config[a]=!0;break;case"placeholder":{var r=this.limitation["maxcount"];let t;try{if(t=JSON.parse(i),!Array.isArray(t))throw new Error(_wcl.classToTagName(this.constructor.name)+": placeholder should be array.")}catch(e){console.warn(_wcl.classToTagName(this.constructor.name)+": "+e.message),t=[...defaults[a]]}this.#config[a]=t.filter((e={})=>e?.src).slice(0,r);break}case"limitation":case"webservice":{let t;try{t=JSON.parse(i)}catch(e){console.warn(_wcl.classToTagName(this.constructor.name)+": "+e.message),t={...defaults[a]}}if("webservice"===a){let e=+t.timeout;(isNaN(e)||e<=0)&&(e=defaults.webservice.timeout),t.timeout=e}this.#config[a]=t;break}}else booleanAttrs.includes(a)?this.#config[a]=!1:this.#config[a]=defaults[a]}#getUnitId(){return"unit-"+_wcl.getUUID()}attributeChangedCallback(e,t,a){if(MscImageUploader.observedAttributes.includes(e))switch(this.#format(e,t,a),e){case"multiple":this.#nodes.input.multiple=this.multiple;break;case"limitation":var i=this.limitation["accept"];this.#nodes.input.accept=i;break;case"placeholder":{this.removeAll();const r={};i=this.placeholder.reduce((e,t)=>{var a=t["src"],i=this.#getUnitId();return r[i]={...t},e.concat({id:i,src:a,status:"normal"})},[]),i=(this.#data.units={...r},Mustache.render(templateUnit.innerHTML,{units:i}));this.#nodes.grids.insertAdjacentHTML("beforeend",i),this.#markDecorations(),this.#updateStorage();break}}}static get observedAttributes(){return Object.keys(defaults)}static get supportedKeyboardKeys(){return legalKey}static get supportedEvents(){return Object.keys(custumEvents).map(e=>custumEvents[e])}#upgradeProperty(e){let t;MscImageUploader.observedAttributes.includes(e)&&(Object.prototype.hasOwnProperty.call(this,e)?(t=this[e],delete this[e]):t=booleanAttrs.includes(e)?!(!this.hasAttribute(e)&&!this.#config[e]):objectAttrs.includes(e)?this.hasAttribute(e)?this.getAttribute(e):JSON.stringify(this.#config[e]):this.hasAttribute(e)?this.getAttribute(e):this.#config[e],this[e]=t)}set fieldname(e){e?this.setAttribute("fieldname",e):this.removeAttribute("fieldname")}get fieldname(){return this.#config.fieldname}set limitation(e){e?(e={...defaults.limitation,...this.limitation,..."string"==typeof e?JSON.parse(e):e},this.setAttribute("limitation",JSON.stringify(e))):this.removeAttribute("limitation")}get limitation(){return this.#config.limitation}set webservice(e){e?(e={...defaults.webservice,...this.webservice,..."string"==typeof e?JSON.parse(e):e},this.setAttribute("webservice",JSON.stringify(e))):this.removeAttribute("webservice")}get webservice(){return this.#config.webservice}set placeholder(e){e?(e="string"==typeof e?JSON.parse(e):Array.isArray(e)?e:defaults.placeholder,this.setAttribute("placeholder",JSON.stringify(e))):this.removeAttribute("placeholder")}get placeholder(){return this.#config.placeholder}set multiple(e){this.toggleAttribute("multiple",Boolean(e))}get multiple(){return this.#config.multiple}get processing(){return 0<Array.from(this.#nodes.grids.querySelectorAll(".msc-image-uploader__unit[data-status=process]")).length}get uploadInfo(){return Array.from(this.#nodes.grids.querySelectorAll(".msc-image-uploader__unit:not(label)")).reduce((e,t)=>{t=t.id,t=this.#data.units[t];return t?e.concat({...t}):e},[])}get count(){return Array.from(this.#nodes.grids.querySelectorAll(".msc-image-uploader__unit:not(label)")).length}#updateStorage(){let e=this.querySelector("input[type=hidden]");e||((e=document.createElement("input")).type="hidden",e.name="msc-image-uploader",this.appendChild(e)),e.value=JSON.stringify(this.uploadInfo.filter(({error:e})=>!e))}#fireEvent(e,t){this.dispatchEvent(new CustomEvent(e,{bubbles:!0,composed:!0,...t&&{detail:t}}))}#mutateSize({width:e,height:t}){_wcl.addStylesheetRules(".msc-image-uploader__unit__decoy--mutate-size",{"--inline-size":e+"px","--block-size":t+"px"},this.#nodes.styleSheet)}#mutateAxis({pX:e,pY:t}){var{dX:a,dY:i}=this.#data;_wcl.addStylesheetRules(".msc-image-uploader__unit__decoy--mutate-axis",{"--x":e-_wcl.scrollX-a+"px","--y":t-_wcl.scrollY-i+"px"},this.#nodes.styleSheet)}#swapUnits(e){var t,a,{grids:i,activeTarget:r}=this.#nodes;e!==r&&(r.nextElementSibling===e?e.after(r):r.previousElementSibling===e?e.before(r):(t=r.nextElementSibling,(a=e.nextElementSibling)?a.before(r):i.appendChild(r),t?t.before(e):i.appendChild(e)),this.#markDecorations(),this.#updateStorage())}#markDecorations(){Array.from(this.#nodes.grids.querySelectorAll(".msc-image-uploader__unit:not(label)")).forEach((e,t)=>{e.firstElementChild.part="decoration decorations-"+(t+1)})}#getThumbnail({naturalWidth:e,naturalHeight:t,dataURL:a}){var i=new Image,r=document.createElement("canvas"),o=r.getContext("2d");let s,n,l;return i.src=a,r.width=160,r.height=160,l=t<=e?(s=Math.floor((e-t)/2),n=0,t):(s=0,n=Math.floor((t-e)/2),e),o.drawImage(i,s,n,l,l,0,0,160,160),r.toDataURL("image/jpeg",.75)}#findOverTarget({pX:r,pY:o}){var{units:e,activeTarget:t}=this.#nodes;const s=_wcl.scrollX,n=_wcl.scrollY;var a=e.findIndex(e=>{var{x:e,y:t,width:a,height:i}=e.getBoundingClientRect(),e=e+s,a=e+a,t=t+n;return e<=r&&r<=a&&t<=o&&o<=t+i});return e[a]||t}async#fetchImageInfo(a){return new Promise((r,t)=>{var e=new FileReader;e.onload=e=>{const a=e.target.result,i=new Image;i.onload=()=>{var{naturalWidth:e,naturalHeight:t}=i;r({naturalWidth:e,naturalHeight:t,dataURL:a})},i.onerror=()=>{t(new Error("fetch image info error."))},i.src=a},e.readAsDataURL(a)})}async#validation(e){let t;try{var{size:a,minwidth:i,minheight:r}=this.limitation,{naturalWidth:o,naturalHeight:s,dataURL:n}=await this.#fetchImageInfo(e);if(e.size>a)throw new Error(`image size must under ${a} bytes.`);if(o<i)throw new Error(`image width must be bigger than ${i}px.`);if(s<r)throw new Error(`image height must be bigger than ${i}px.`);t={dataURL:this.#getThumbnail({naturalWidth:o,naturalHeight:s,dataURL:n}),file:e}}catch(e){console.warn(_wcl.classToTagName(this.constructor.name)+": "+e.message),this.#fireEvent(custumEvents.error,{message:e.message}),t={error:e.message}}return t}#upload(e){var t=this.#nodes["grids"],{src:e,file:a}=e;const i=this.#getUnitId();e=[{id:i,src:e,status:"process"}],e=Mustache.render(templateUnit.innerHTML,{units:e});t.insertAdjacentHTML("beforeend",e),this.#markDecorations();const r=t.querySelector("#"+i),o=r.querySelector("msc-circle-progress"),{url:s,params:n,header:l,timeout:c,withCredentials:d}=this.webservice;e=/^http(s)?:\/\/.*/.test(s)?void 0:window.location.origin,t=new URL(s,e);const u=new XMLHttpRequest,m=new FormData;u.open("POST",t,!0),u.timeout=c,u.withCredentials=Boolean(d),Object.keys(l).forEach(e=>u.setRequestHeader(e,l[e])),Object.keys(n).forEach(e=>m.set(e,n[e])),m.set(this.fieldname,a),u.upload.onprogress=e=>{var{lengthComputable:e,loaded:t,total:a}=e;e&&(o.value=Math.round(100*t/a))},u.upload.onload=()=>{o.value=100},u.ontimeout=()=>{r.dataset.status="warn",this.#data.units[i]={error:{message:"fetch timeout."}}},u.onabort=()=>{r.dataset.status="warn",this.#data.units[i]={error:{message:"fetch abort."}}},u.onerror=()=>{r.dataset.status="warn",this.#data.units[i]={error:{message:"fetch unknow error."}}},u.onreadystatechange=()=>{if(4===u.readyState){var{response:t,status:e}=u;try{var a=0<t?.length?JSON.parse(t):{};if(!/^2\d{2,}/.test(e))throw new Error("fetch is not a successful responses.",{...0<Object.keys(a).length&&{cause:a}});r.dataset.status="normal",this.#data.units[i]={...a}}catch(e){console.warn(_wcl.classToTagName(this.constructor.name)+": "+e.message);t=void 0!==e.cause?e.cause:void 0;this.#fireEvent(custumEvents.error,{message:e.message,...t&&{cause:t}}),r.dataset.status="warn",this.#data.units[i]={error:{message:e.message,...t&&{cause:t}}}}this.#updateStorage(),this.processing||setTimeout(()=>{this.#fireEvent(custumEvents.done)},0===e?100:0)}},u.send(m)}_onClick(e){var t=e.target.closest("button"),a=e.target.closest(".msc-image-uploader__unit:not(label)");t&&a&&(e.preventDefault(),a.classList.add("msc-image-uploader__unit--dismiss"))}_onDown(e){var t,a,i,r,o,s=e.target.closest("button"),n=e.target.closest(".msc-image-uploader__unit:not(label)"),{main:l,grids:c,decoy:d}=this.#nodes;s&&n?n.classList.add("msc-image-uploader__unit--dismiss"):!n||void 0!==e.buttons&&1!==e.buttons||l.dataset.action||(e.preventDefault(),l.dataset.action="dragging",this.#data.ddController=new AbortController,s=document.querySelector("html"),l=this.#data.ddController.signal,{x:e,y:t}=_wcl.pointer(e),{x:a,y:i,width:r,height:o}=n.getBoundingClientRect(),this.#data.dX=e-(_wcl.scrollX+a),this.#data.dY=t-(_wcl.scrollY+i),this.#nodes.activeTarget=n,this.#nodes.units=Array.from(c.querySelectorAll(".msc-image-uploader__unit:not(label)")),this.#mutateSize({width:r,height:o}),this.#mutateAxis({pX:e,pY:t}),d.querySelector("img").replaceWith(n.querySelector("img").cloneNode(!0)),d.classList.toggle("msc-image-uploader__unit__decoy--show",!0),n.dataset.formerstatus=n.dataset.status,n.dataset.status="drag",n.focus(),s.addEventListener(evtMove,this._onMove,{signal:l}),s.addEventListener(evtUp,this._onUp,{signal:l}))}_onMove(e){var t=this.#nodes["main"];void 0!==e.buttons&&1!==e.buttons||!t.dataset.action||({x:t,y:e}=_wcl.pointer(e),this.#mutateAxis({pX:t,pY:e}),this.#swapUnits(this.#findOverTarget({pX:t,pY:e})))}_onUp(e){var{main:t,activeTarget:a,decoy:i}=this.#nodes;void 0!==e.buttons&&1&e.buttons||!t.dataset.action||(this.#data.ddController.abort(),delete t.dataset.action,i.classList.toggle("msc-image-uploader__unit__decoy--show",!1),e=a.dataset["formerstatus"],"process"!==e&&(a.dataset.status=e),delete a.dataset.formerstatus,this.#updateStorage())}_onAnimationEnd(e){var e=e.target,t=e.id;e.remove(),this.#data.units[t]&&delete this.#data.units[t],this.#fireEvent(custumEvents.remove),this.#markDecorations(),this.#updateStorage()}_onKeyDown(e){var{main:t,grids:a}=this.#nodes,i=e["key"],r=this.shadowRoot.activeElement.closest(".msc-image-uploader__unit:not(label)");if(MscImageUploader.supportedKeyboardKeys.includes(i)&&!t.dataset.action&&r){e.preventDefault();var o=Array.from(a.querySelectorAll(".msc-image-uploader__unit:not(label)")),s=o.length,n=o.indexOf(r),l=+window.getComputedStyle(t).getPropertyValue("--column-count").trim(),c=Math.ceil((s+1)/l);switch(this.#nodes.activeTarget=r,i){case"Escape":r.blur();break;case"ArrowLeft":this.#swapUnits(o[(n-1+s)%s]);break;case"ArrowRight":this.#swapUnits(o[(n+1+s)%s]);break;case"ArrowDown":{let t=n+1+l;if(!o[t-1])for(let e=-1;++e<c;){var d=n+1-e*l;o[d-1]&&(t=d)}this.#swapUnits(o[t-1]);break}case"ArrowUp":{let t=n+1-l;if(!o[t-1])for(let e=-1;++e<c;){var u=n+1+e*l;o[u-1]&&(t=u)}this.#swapUnits(o[t-1]);break}}"Escape"!==i&&r.focus()}}_onDnD(e){var{type:t,dataTransfer:a}=e;e.preventDefault(),"drop"===t&&(e.stopPropagation(),this._onFilesChange({target:{files:a.files}}))}_onPaste(e){e=e.clipboardData||window.clipboardData;this._onFilesChange({target:{files:e.files}})}async _onFilesChange(e){var t,a,i,e=e["target"]["files"];e&&e.length&&(t=this.limitation["maxcount"],{main:a,input:i}=this.#nodes,a.classList.add("main--loading"),e=await Promise.all(Array.from(e).map(e=>this.#validation(e))),a.classList.remove("main--loading"),e.reduce((e,t)=>{var{dataURL:t,file:a}=t;return t?e.concat({src:t,file:a}):e},[]).slice(0,t-this.count).forEach(e=>{this.#upload(e)}),i.value="",this.#fireEvent(custumEvents.pick))}showPicker(){this.#nodes.input?.showPicker()}removeAll(){var e=this.#nodes["grids"];Array.from(e.querySelectorAll(".msc-image-uploader__unit:not(label)")).forEach(e=>{e.remove()}),this.#data.units={},this.#updateStorage()}}const S=_wcl.supports(),T=_wcl.classToTagName(MscImageUploader.name);if(S.customElements&&S.shadowDOM&&S.template&&!window.customElements.get(T)){window.customElements.define(T,MscImageUploader),_wcl.addStylesheetRules(".msc-image-uploader--dnd",{"--msc-image-uploader-main-drop-display":"block"});let t=0;const Ub=document.querySelector("html"),Vb=e=>{switch(e.preventDefault(),e.type){case"dragenter":t+=1;break;case"dragleave":--t;break;case"drop":t=0}document.body.classList.toggle("msc-image-uploader--dnd",Boolean(t))};["dragenter","dragleave","dragover","drop"].forEach(e=>{Ub.addEventListener(e,Vb,{capture:!0})})}export{MscImageUploader};